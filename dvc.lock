schema: '2.0'
stages:
  preprocess:
    cmd: python -u source/preprocess.py
    deps:
    - path: data/raw/
      hash: md5
      md5: 25e54827bb56e0446b074ca8411aec84.dir
      size: 39391890330
      nfiles: 305982
    - path: source/preprocess.py
      hash: md5
      md5: 384ea4345776f9d6e3e5371e6eec5dea
      size: 17607
    params:
      params.yaml:
        preprocess:
          input_path_train: data/raw/nsynth-train
          output_path_train: data/processed/train
          input_path_valid: data/raw/nsynth-valid
          output_path_valid: data/processed/valid
          input_path_test: data/raw/nsynth-test
          output_path_test: data/processed/test
          model_name: facebook/encodec_24khz
          sample_rate: 24000
          initial_db_size: 1
          db_writemap: false
          ext:
          - wav
          num_workers: 30
          batch_size: 8
    outs:
    - path: data/processed/
      hash: md5
      md5: 6e310ab2456715138e33193d0554577d.dir
      size: 130354565120
      nfiles: 6
  train_vae:
    cmd: python -u source/train_vae.py
    deps:
    - path: source/dataset.py
      hash: md5
      md5: 3caee1c3da1c555a8ca9aea750228bda
      size: 6338
    - path: source/train_vae.py
      hash: md5
      md5: 6b7011d35a2e0ea98ee5883d11e2fd85
      size: 15216
    - path: source/vae.py
      hash: md5
      md5: 583f1af29bc4c1b72f7fe87f6e101a25
      size: 9913
    params:
      params.yaml:
        train:
          vae:
            epochs: 500
            batch_size: 1024
            lr: 0.0001
            wd: 0.05
            betas:
            - 0.9
            - 0.95
            dropout_ratio: 0.0
            eval_interval: 5
            visualize_interval: 10
            hear_interval: 10
            save_interval: 20
            input_crop: 150
            channels:
            - 128
            - 256
            - 512
            - 1024
            - 2048
            - 4096
            linears:
            - 16384
            - 8192
            - 4096
            - 2048
            - 1024
            - 512
            - 2
            calculate_vae_loss:
              _target_: vae.calculate_vae_loss
              _partial_: true
              num_epochs: 500
              weighted_reproduction: false
              loss_fn:
                _target_: torch.nn.MSELoss
                reduction: sum
              cls_loss_fn:
                _target_: torch.nn.CrossEntropyLoss
              batch_size: 1024
          transformer:
            epochs: 2000
            learning_rate: 0.0001
            weight_decay: 0.05
            betas:
            - 0.9
            - 0.95
            batch_size: 256
            eval_interval: 200
            visualize_interval: 200
            hear_interval: 200
            save_interval: 1000
            block_size: 300
            input_dimension: 128
            internal_dimension: 512
            feedforward_dimension: 2048
            n_layer_encoder: 8
            n_layer_decoder: 11
            n_head: 8
            dropout: 0.0
            condition_model_path: out/vae/checkpoints/vae_final_epoch_150.torch
            loss_fn:
              _target_: torch.nn.MSELoss
              reduction: mean
          db_path_train: data/processed/train
          db_path_valid: data/processed/valid
          db_path_test: data/processed/test
          random_seed: 42
          num_workers: 30
          pitch: -1
          device: auto
    outs:
    - path: out/vae/
      hash: md5
      md5: e21c4d0207dc49209dd63b914f17eee7.dir
      size: 118711527328
      nfiles: 40
  train_transformer:
    cmd: python -u source/train_transformer.py
    deps:
    - path: out/vae/
      hash: md5
      md5: 311da7abca314c649598ed3ddfff12d1.dir
      size: 13698842006
      nfiles: 17
    - path: source/dataset.py
      hash: md5
      md5: 3caee1c3da1c555a8ca9aea750228bda
      size: 6338
    - path: source/train_transformer.py
      hash: md5
      md5: aecf78e33a719bc6b6ebacc0a84b34c7
      size: 13384
    - path: source/transformer.py
      hash: md5
      md5: 6d3c97a8026f2685f2fd3b064320b7f4
      size: 3835
    params:
      params.yaml:
        train:
          vae:
            epochs: 150
            batch_size: 512
            lr: 0.0001
            wd: 0.05
            betas:
            - 0.9
            - 0.95
            dropout_ratio: 0.2
            eval_interval: 5
            visualize_interval: 25
            hear_interval: 25
            save_interval: 50
            input_crop: 150
            channels:
            - 128
            - 256
            - 512
            - 1024
            - 2048
            - 4096
            linears:
            - 16384
            - 8192
            - 4096
            - 2048
            - 1024
            - 512
            - 2
            calculate_vae_loss:
              _target_: vae.calculate_vae_loss
              _partial_: true
              epochs: 150
              weighted_reproduction: false
              loss_fn:
                _target_: torch.nn.MSELoss
                reduction: sum
              cls_loss_fn:
                _target_: torch.nn.CrossEntropyLoss
              batch_size: 512
          db_path_train: data/processed/train
          db_path_valid: data/processed/valid
          db_path_test: data/processed/test
          random_seed: 42
          num_workers: 0
          pitch: -1
    outs:
    - path: out/transformer/
      hash: md5
      md5: 6f086ab81f2e0a24da47b33012749219.dir
      size: 32
      nfiles: 1
